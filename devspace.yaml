version: v1beta11

vars:
  - name: IMAGE
    value: ci4rail/anck
  - name: IMAGE-ANCKCREDENTIALS
    value: ci4rail/anck-credentials

dependencies:
  - name: k3d
    source:
      git: https://github.com/edgefarm/devspace.base
      subPath: /environments/k3d
      branch: main
  - name: anckcredentials
    source:
      git: https://github.com/edgefarm/anck-credentials.git
      subPath: /
      branch: main

commands:
  - name: init
    command: |-
      devspace run update
      devspace run k3d.init

  - name: purge
    command: |-
      devspace run k3d.purge

  - name: activate
    command: |-
      devspace run k3d.activate

  - name: update
    command: |-
      devspace update dependencies

# dev:
#   ports:
#     - imageSelector: ${IMAGE}
#       forward:
#         - port: 23451 # Forward the port from the Pod to localhost:23451
#           remotePort: 2345
#     - imageSelector: ${IMAGE-ANCKCREDENTIALS}
#       namespace: anck
#       forward:
#         - port: 6000
#         - port: 23450 # Forward the port from the Pod to localhost:23450
#           remotePort: 2345
#   sync:
#     - imageSelector: ${IMAGE}
#       localSubPath: ./
#       excludePaths:
#         - .git/
#     - imageSelector: ${IMAGE-ANCKCREDENTIALS}
#       namespace: anck
#       localSubPath: ../anck-credentials/
#       excludePaths:
#         - .git/
#   terminal:
#     imageSelector: ${IMAGE}
#     command:
#       - bash

#   replacePods:
#     - imageSelector: ${IMAGE}
#       replaceImage: loftsh/go:latest
#       patches:
#         - op: replace
#           path: spec.containers[1].command
#           value:
#             - sleep
#         - op: replace
#           path: spec.containers[1].args
#           value:
#             - "9999999"
#         - op: remove
#           path: spec.containers[1].securityContext
#     # - imageSelector: ${IMAGE-ANCKCREDENTIALS}
#     #   replaceImage: loftsh/go:latest
#     #   namespace: anck
#     #   patches:
#     #     - op: replace
#     #       path: spec.containers[0].command
#     #       value:
#     #         - sleep
#     #     - op: replace
#     #       path: spec.containers[0].args
#     #       value:
#     #         - "9999999"
#     #     - op: remove
#     #       path: spec.containers[0].securityContext

#   # - name: anck
#   #   kubectl:
#   #   kustomize: true
#   #     manifests:
#   #       - ../anck/manifests/crds

deployments:
  - name: anck
    namespace: anck
    kubectl:
      kustomize: true
      manifests:
        - config/default
  # - name: anck-rbac
  #   namespace: system
  #   kubectl:
  #     manifests:
  #       - config/rbac/role.yaml
  #       - config/rbac/role_binding.yaml
  #       - config/rbac/service_account.yaml
