version: v1beta11

vars:
  - name: IMAGE
    value: ci4rail/anck:latest
  - name: IMAGE-ANCKCREDENTIALS
    value: ci4rail/anck-credentials

dependencies:
#   - name: k3d
#     source:
#       git: https://github.com/edgefarm/devspace.base
#       subPath: /environments/k3d
#       branch: main
#   - name: anckcredentials
#     source:
#       git: https://github.com/edgefarm/anck-credentials.git
#       subPath: /
#       branch: main

# commands:
#   - name: init
#     command: |-
#       devspace run update
#       devspace run k3d.init

#   - name: purge
#     command: |-
#       devspace run k3d.purge

#   - name: activate
#     command: |-
#       devspace run k3d.activate

#   - name: update
#     command: |-
#       devspace update dependencies

dev:
  ports:
    - imageSelector: ${IMAGE}
      forward:
        - port: 23451 # Forward the port from the Pod to localhost:23451
          remotePort: 2345
    # # Uncomment to debug anck-credentials as well
    # - imageSelector: ${IMAGE-ANCKCREDENTIALS}
    #   namespace: anck
    #   forward:
    #     - port: 6000
    #     - port: 23450 # Forward the port from the Pod to localhost:23450
    #       remotePort: 2345
  sync:
    - imageSelector: ${IMAGE}
      localSubPath: ./
      excludePaths:
        - .git/
    # # Uncomment to sync changes from ../anck-credentials/ in container
    # # Only required, when conainter image is replaced with golang container
    # # Requires, anck-credentials repository placed at ../anck-credentials/
    # - imageSelector: ${IMAGE-ANCKCREDENTIALS}
    #   namespace: anck
    #   localSubPath: ../anck-credentials/
    #   excludePaths:
    #     - .git/
  terminal:
    imageSelector: ${IMAGE}
    command:
      - bash

  replacePods:
    - imageSelector: ${IMAGE}
      replaceImage: ghcr.io/loft-sh/devspace-containers/go:1.18-alpine
      patches:
        - op: replace
          path: spec.containers[1].command
          value:
            - sleep
        - op: replace
          path: spec.containers[1].args
          value:
            - "999999999"
        - op: remove
          path: spec.containers[1].securityContext
        - op: remove
          path: spec.containers[1].resources.limits
        - op: remove
          path: spec.containers[1].resources.requests
        - op: remove
          path: spec.containers[0].resources.limits
        - op: remove
          path: spec.containers[0].resources.requests
    # # Uncomment to replace conainter image with golang container to manually run application or debug
    # # Requires sync changes from ../anck-credentials/ in container
    # - imageSelector: ${IMAGE-ANCKCREDENTIALS}
    #   replaceImage: ghcr.io/loft-sh/devspace-containers/go:1.18-alpine
    #   namespace: anck
    #   patches:
    #     - op: replace
    #       path: spec.containers[0].command
    #       value:
    #         - sleep
    #     - op: replace
    #       path: spec.containers[0].args
    #       value:
    #         - "9999999"
    #     - op: remove
    #       path: spec.containers[0].securityContext

deployments:
  - name: anck
    namespace: anck
    kubectl:
      kustomize: true
      manifests:
        - config/default
